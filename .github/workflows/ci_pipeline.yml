name: Continuous Integration Pipeline

# ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù€ Workflow Ø¹Ù†Ø¯ ÙƒÙ„ Ø¯ÙØ¹ (Push) Ø¥Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ¹Ù†Ø¯ ÙØªØ­ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Pull Request.
on:
  push:
    branches: [ "master", "develop" ]
  pull_request:
    branches: [ "master", "develop" ]
    types: [opened, synchronize, reopened]

jobs:
  # 1. Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  lint-and-build:
    name: Code Quality & Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm ci

      # ğŸš¨ Ù…Ù‡Ù…Ø©: ØªÙˆÙ„ÙŠØ¯ Prisma Client
      # Ù†Ø¶Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙÙ†Ø´Ø£ (Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… Ù†Ø³ÙŠØ§Ù†Ù‡ ÙÙŠ Ø§Ù„Ø±ÙØ¹)
      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma generate



      # ğŸ› ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±Ø¬Ù…Ø© ÙˆØ§Ù„Ø¨Ù†Ø§Ø¡ (Typescript Build)
      # Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ù€ Types
      - name: Run TypeScript Build
        run: npm run build



  # 2. Ù…Ø±Ø­Ù„Ø© SonarCloud (Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ù…Ù† ÙˆØ§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©)
  sonarcloud:
    name: SonarCloud Security Analysis
    runs-on: ubuntu-latest
    needs: [lint-and-build] # â¬…ï¸ Ù„Ø§ ØªÙØ´ØºÙ„ SonarCloud Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ù†Ø¬Ø­Øª Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù€ Build
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ù…Ø·Ù„ÙˆØ¨ Ø¨ÙˆØ§Ø³Ø·Ø© SonarCloud Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Git ÙƒØ§Ù…Ù„

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2.2.0
        env:
          # Token Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙÙŠ SonarCloud
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }} 
          # Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø®ØµØµ Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ ÙÙŠ SonarCloud (ÙŠØ¬Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
        with:
          # Ù‡Ø°Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ SonarCloud
          projectKey: 'blaxinoss'
          # Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¸Ù…Ø© ÙÙŠ SonarCloud
          organization: 'Abdullah'
